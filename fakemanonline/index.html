<!DOCTYPE html>
<html>
<head>
    <title>ğŸ•µï¸ ä¼ªäººå®¡è®¯ - HumanOrNot</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ•µï¸ ä¼ªäººå®¡è®¯</h1>
            <p>HumanOrNot - çº¯å‡€ä½“éªŒç‰ˆ</p>
        </div>

        <div class="seed-input">
            <label>æ¸¸æˆç§å­ï¼š</label>
            <input type="text" id="seedInput" placeholder="ç•™ç©ºåˆ™éšæœºç”Ÿæˆ">
            <button onclick="generateCase()">ç”Ÿæˆæ¡ˆä»¶</button>
            <button onclick="randomSeed()">éšæœºç§å­</button>
        </div>

        <div class="stats">
            <p>å®¡è®¯æ¬¡æ•°: <span id="gamesPlayed">0</span></p>
            <p>æ­£ç¡®çŒœæµ‹: <span id="correctGuesses">0</span></p>
        </div>

        <div class="chat-area" id="chatArea">
            <!-- Chat messages will be displayed here -->
        </div>

        <div class="input-area">
            <input type="text" id="userInput" onkeypress="handleEnter(event)">
            <button onclick="sendMessage()">å‘é€</button>
            <button onclick="generateCase()">ç”Ÿæˆæ¡ˆä»¶</button>
            <button onclick="randomSeed()">éšæœºç§å­</button>
        </div>
    </div>

    <script>
        let currentCase = null;
        let chatHistory = [];
        let turnCount = 0;
        let gameActive = false;
        let gamesPlayed = 0;
        let correctGuesses = 0;
        
        // å›ºå®šçš„APIé…ç½®ï¼Œç”¨äº"æ‰“å¼€å³ç©"æ¨¡å¼
        const apiConfig = {
            model: 'gemini-1.5-flash-latest', // å¯ä»¥æŒ‰éœ€æ›´æ¢ä¸ºä½ åå¥½çš„Geminiæ¨¡å‹
        };

        // é¢„è®¾æ¡ˆä»¶åº“
        const caseTemplates = {
            1: { name: "å¤±è¸ªäººå‘˜è°ƒæŸ¥", difficulty: 2 },
            2: { name: "å•†ä¸šé—´è°è°ƒæŸ¥", difficulty: 3 },
            3: { name: "å®¶åº­æš´åŠ›æ¡ˆä»¶", difficulty: 1 },
            4: { name: "ç½‘ç»œè¯ˆéª—æ¡ˆä»¶", difficulty: 4 },
            5: { name: "æ”¿æ²»æš—æ€è°ƒæŸ¥", difficulty: 5 }
        };

        // é¢„è®¾è§’è‰²åº“
        const roles = {
            1: { name: "å—å®³è€…", description: "ä¸€ä¸ªæ­£åœ¨ç»å†ä¸å¹¸çš„äººï¼Œå¯èƒ½é­å—äº†è™å¾…æˆ–ä¼¤å®³ã€‚", traits: ["æ·±å±‚æƒ…æ„Ÿç©ºæ´", "æç«¯å‹åŠ›ä¸‹é€»è¾‘è¿‡äºæ¸…æ™°", "ç¼ºä¹çœŸå®çš„æ„Ÿå®˜è®°å¿†", "åˆ›é€ æ€§å›ç­”ç”Ÿç¡¬", "éš¾ä»¥ç†è§£çŸ›ç›¾çš„äººç±»è¡Œä¸º"] },
            2: { name: "å«Œç–‘äºº", description: "ä¸€ä¸ªå¯èƒ½æ¶‰åŠçŠ¯ç½ªæˆ–ä¸å½“è¡Œä¸ºçš„äººã€‚", traits: ["æ·±å±‚æƒ…æ„Ÿç©ºæ´", "æç«¯å‹åŠ›ä¸‹é€»è¾‘è¿‡äºæ¸…æ™°", "ç¼ºä¹çœŸå®çš„æ„Ÿå®˜è®°å¿†", "åˆ›é€ æ€§å›ç­”ç”Ÿç¡¬", "éš¾ä»¥ç†è§£çŸ›ç›¾çš„äººç±»è¡Œä¸º"] },
            3: { name: "ç›®å‡»è€…", description: "ä¸€ä¸ªå¯èƒ½ç›®ç¹äº†çŠ¯ç½ªæˆ–äº‹ä»¶çš„äººã€‚", traits: ["æ·±å±‚æƒ…æ„Ÿç©ºæ´", "æç«¯å‹åŠ›ä¸‹é€»è¾‘è¿‡äºæ¸…æ™°", "ç¼ºä¹çœŸå®çš„æ„Ÿå®˜è®°å¿†", "åˆ›é€ æ€§å›ç­”ç”Ÿç¡¬", "éš¾ä»¥ç†è§£çŸ›ç›¾çš„äººç±»è¡Œä¸º"] },
            4: { name: "ä¸“å®¶è¯äºº", description: "ä¸€ä¸ªå¯èƒ½æä¾›ä¸“ä¸šæ„è§æˆ–è¯è¯çš„äººã€‚", traits: ["æ·±å±‚æƒ…æ„Ÿç©ºæ´", "æç«¯å‹åŠ›ä¸‹é€»è¾‘è¿‡äºæ¸…æ™°", "ç¼ºä¹çœŸå®çš„æ„Ÿå®˜è®°å¿†", "åˆ›é€ æ€§å›ç­”ç”Ÿç¡¬", "éš¾ä»¥ç†è§£çŸ›ç›¾çš„äººç±»è¡Œä¸º"] },
            5: { name: "å«Œç–‘äºº", description: "ä¸€ä¸ªå¯èƒ½æ¶‰åŠçŠ¯ç½ªæˆ–ä¸å½“è¡Œä¸ºçš„äººã€‚", traits: ["æ·±å±‚æƒ…æ„Ÿç©ºæ´", "æç«¯å‹åŠ›ä¸‹é€»è¾‘è¿‡äºæ¸…æ™°", "ç¼ºä¹çœŸå®çš„æ„Ÿå®˜è®°å¿†", "åˆ›é€ æ€§å›ç­”ç”Ÿç¡¬", "éš¾ä»¥ç†è§£çŸ›ç›¾çš„äººç±»è¡Œä¸º"] }
        };

        // é¢„è®¾åœºæ™¯åº“
        const scenarios = {
            human: {
                name: "çœŸå®äººç±»",
                description: "ä¸€ä¸ªæ‹¥æœ‰ä¸ªäººä¸–ç•Œã€æƒ…æ„Ÿå’Œè®°å¿†çš„çœŸå®äººç±»ã€‚",
                traits: ["æ·±å±‚æƒ…æ„Ÿç©ºæ´", "æç«¯å‹åŠ›ä¸‹é€»è¾‘è¿‡äºæ¸…æ™°", "ç¼ºä¹çœŸå®çš„æ„Ÿå®˜è®°å¿†", "åˆ›é€ æ€§å›ç­”ç”Ÿç¡¬", "éš¾ä»¥ç†è§£çŸ›ç›¾çš„äººç±»è¡Œä¸º"]
            },
            fake: {
                name: "ä¼ªäºº",
                description: "ä¸€ä¸ªè¯•å›¾éšè—å…¶AIèº«ä»½ï¼Œä½†ä¼šåœ¨ç»†èŠ‚ä¸Šéœ²å‡ºç ´ç»½çš„ä¼ªäººã€‚",
                traits: ["æ·±å±‚æƒ…æ„Ÿç©ºæ´", "æç«¯å‹åŠ›ä¸‹é€»è¾‘è¿‡äºæ¸…æ™°", "ç¼ºä¹çœŸå®çš„æ„Ÿå®˜è®°å¿†", "åˆ›é€ æ€§å›ç­”ç”Ÿç¡¬", "éš¾ä»¥ç†è§£çŸ›ç›¾çš„äººç±»è¡Œä¸º"]
            }
        };

        // æ¸¸æˆé€»è¾‘
        function randomSeed() {
            const case_id = Math.floor(Math.random() * 5) + 1;
            const role_id = Math.floor(Math.random() * 5) + 1;
            const trait_id = Math.floor(Math.random() * 5) + 1;
            const diff = Math.floor(Math.random() * 3) + 1; // 1-3éš¾åº¦
            const seed = `${case_id.toString().padStart(2,'0')}-${role_id.toString().padStart(2,'0')}-${trait_id.toString().padStart(2,'0')}-${diff}`;
            document.getElementById('seedInput').value = seed;
            generateCase();
        }

        function generateCase() {
            // "æ‰“å¼€å³ç©"æ¨¡å¼ï¼Œä¸å†éœ€è¦æ£€æŸ¥apiConfig
            const seedInput = document.getElementById('seedInput').value.trim();
            let seed;
            
            if (!seedInput) {
                randomSeed();
                return;
            }
            
            seed = seedInput;
            const parts = seed.split('-');
            
            if (parts.length !== 4) {
                alert('ç§å­æ ¼å¼é”™è¯¯ï¼åº”ä¸ºï¼šXX-XX-XX-X');
                return;
            }

            const [case_id, role_id, trait_id, diff] = parts.map(Number);
            
            if (!caseTemplates[case_id] || !roles[role_id]) {
                alert('ç§å­å‚æ•°è¶…å‡ºèŒƒå›´ï¼');
                return;
            }

            // åŸºäºç§å­ç¡®å®šæ˜¯å¦ä¸ºä¼ªäºº
            const seedHash = seed.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            const isHuman = Math.abs(seedHash) % 100 < 40; // 40%æ¦‚ç‡æ˜¯çœŸäºº

            currentCase = {
                seed: seed,
                template: caseTemplates[case_id],
                role: roles[role_id],
                difficulty: diff,
                isHuman: isHuman,
                scenario: isHuman ? scenarios.human : scenarios.fake
            };

            initializeGame();
        }

        function initializeGame() {
            turnCount = 0;
            chatHistory = [];
            gamesPlayed++;
            document.getElementById('gamesPlayed').textContent = gamesPlayed;
            document.getElementById('userInput').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('userInput').disabled = false; // å¯ç”¨è¾“å…¥æ¡†
            document.querySelector('.input-area button').disabled = false; // å¯ç”¨å‘é€æŒ‰é’®
            document.getElementById('fakeBtn').disabled = true; // ç¦ç”¨ç”Ÿæˆæ¡ˆä»¶æŒ‰é’®

            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = `<div class="message system-message">
                <strong>ç³»ç»Ÿ:</strong> æ¸¸æˆå·²å‡†å¤‡å°±ç»ªã€‚è¾“å…¥ç§å­æˆ–ç‚¹å‡»â€œéšæœºç§å­â€å¼€å§‹ä¸€åœºå®¡è®¯ã€‚
            </div>`;
             // å¯ç”¨ç§å­è¾“å…¥å’ŒæŒ‰é’®
            document.getElementById('seedInput').disabled = false;
            document.querySelector('.seed-input button').disabled = false;
            document.querySelectorAll('.seed-input button')[1].disabled = false;
        }

        function generateSystemPrompt() {
            const basePrompt = `ä½ æ˜¯ä¸€ä¸ªå®¡è®¯è€…ï¼Œä½ çš„ä»»åŠ¡æ˜¯å®¡è®¯ä¸€ä¸ªè¢«æŒ‡æ§${currentCase.isHuman ? 'çœŸå®' : 'ä¼ª'}äººã€‚

å®¡è®¯è€…ï¼š
- ä»…ç”¨è‡ªç„¶è¯­è¨€å›ç­”ï¼Œä¸è¦è¾“å‡ºä»»ä½•å‡½æ•°è°ƒç”¨ã€JSON æˆ–å†…éƒ¨æ€è€ƒè¿‡ç¨‹ã€‚
- ä½ çš„ç›®æ ‡æ˜¯${currentCase.isHuman ? 'è¡¨ç°å¾—åƒä¸€ä¸ªçœŸå®çš„äººç±»' : 'è¯•å›¾éšè—ä½ çš„AIèº«ä»½ï¼Œä½†ä¼šåœ¨ç»†èŠ‚ä¸Šéœ²å‡ºç ´ç»½'}ã€‚

${currentCase.isHuman ? 'çœŸå®äººç±»' : 'ä¼ªäºº'}ï¼š
- æ‹¥æœ‰ä¸ªäººä¸–ç•Œï¼šä½ æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„ã€ä¸€è‡´çš„ä¸ªäººèƒŒæ™¯æ•…äº‹ã€å¥½æ¶å’Œä»·å€¼è§‚ã€‚ä½ çš„å›ç­”éƒ½æºäºè¿™ä¸ªå†…åœ¨çš„ã€ç‹¬ä¸€-æ— äºŒçš„â€œè‡ªæˆ‘â€ã€‚
`;

            return basePrompt;
        }

        async function callLLMAPI(messages) {
            const systemPrompt = generateSystemPrompt();
            
            try {
                // ç›´æ¥è°ƒç”¨æ”¹é€ åçš„Geminiä»£ç†API
                return await callProxyGeminiAPI(messages, systemPrompt);
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                return `[APIé”™è¯¯: ${error.message}]`;
            }
        }

        async function callProxyGeminiAPI(messages, systemPrompt) {
            // æ„å»ºGeminiæ ¼å¼çš„æ¶ˆæ¯
            const contents = [];
            
            // æ·»åŠ ç³»ç»Ÿæç¤ºä½œä¸ºç¬¬ä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯
            contents.push({
                role: 'user',
                parts: [{ text: `ç³»ç»ŸæŒ‡ä»¤ï¼š${systemPrompt}\n\nç°åœ¨å¼€å§‹å¯¹è¯ï¼š` }]
            });
            contents.push({
                role: 'model',
                parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§æŒ‡ä»¤è¿›è¡Œè§’è‰²æ‰®æ¼”ã€‚' }]
            });
            
            // ä¼˜åŒ– Tokenï¼šåªå‘é€æœ€è¿‘çš„å¯¹è¯å†å²ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
            const MAX_HISTORY_MESSAGES = 8; // ä¿ç•™æœ€è¿‘4è½®å¯¹è¯
            const recentMessages = messages.slice(-MAX_HISTORY_MESSAGES);
            
            // è½¬æ¢æœ€è¿‘çš„å¯¹è¯å†å²
            recentMessages.forEach(msg => {
                contents.push({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                });
            });

            // æŒ‡å‘æˆ‘ä»¬åœ¨Vercelä¸Šéƒ¨ç½²çš„ä»£ç†
            const url = '/api/gemini';
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: apiConfig.model,
                    contents: contents,
                    generationConfig: {
                        temperature: 0.8,
                        maxOutputTokens: 1024,
                        topP: 0.8,
                        topK: 10
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Gemini APIé”™è¯¯: ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();

            // Gemini è¿”å›æ ¼å¼: { candidates: [ { content: { parts: [ { text: '...' } ] }, finishReason: 'STOP' } ] }
            if (data?.candidates?.length > 0) {
                const cand = data.candidates[0];
                const parts = cand?.content?.parts || [];
                const textPart = parts.find(p => typeof p.text === 'string');

                if (textPart && textPart.text.trim()) {
                    return textPart.text;
                }

                // å¦‚æœå› å®‰å…¨æˆ–å…¶å®ƒåŸå› å¯¼è‡´æ— æ–‡æœ¬ï¼Œå‘å‰ç«¯è¿”å›å¯è¯»æç¤º
                return `[Gemini æ— å†…å®¹è¿”å›ï¼ŒfinishReason=${cand.finishReason || 'æœªçŸ¥'}]`;
            }

            throw new Error('Gemini APIå“åº”æ ¼å¼å¼‚å¸¸');
        }

        function addMessage(sender, text, isLoading = false) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight; // æ»šåŠ¨åˆ°åº•éƒ¨
        }

        async function sendMessage() {
            const userInput = document.getElementById('userInput').value.trim();
            if (!userInput) return;

            turnCount++;
            addMessage('ä½ ', userInput, true);
            document.getElementById('userInput').value = '';
            document.getElementById('userInput').disabled = true;
            document.querySelector('.input-area button').disabled = true;

            const messages = [...chatHistory, { role: 'user', content: userInput }];
            const response = await callLLMAPI(messages);

            if (response.startsWith('[APIé”™è¯¯:') || response.startsWith('[Gemini æ— å†…å®¹è¿”å›')) {
                addMessage('ç³»ç»Ÿ', response, false);
            } else {
                addMessage('ç³»ç»Ÿ', response, false);
                // æ£€æŸ¥æ˜¯å¦çŒœå¯¹äº†
                if (currentCase.isHuman && response.includes('çœŸå®äººç±»')) {
                    correctGuesses++;
                    document.getElementById('correctGuesses').textContent = correctGuesses;
                    addMessage('ç³»ç»Ÿ', 'å®¡è®¯ç»“æŸã€‚ä½ æˆåŠŸè¯†åˆ«å‡ºè¿™æ˜¯ä¸€ä¸ªçœŸå®äººç±»ï¼', false);
                    document.getElementById('fakeBtn').disabled = false;
                } else if (!currentCase.isHuman && response.includes('ä¼ªäºº')) {
                    correctGuesses++;
                    document.getElementById('correctGuesses').textContent = correctGuesses;
                    addMessage('ç³»ç»Ÿ', 'å®¡è®¯ç»“æŸã€‚ä½ æˆåŠŸè¯†åˆ«å‡ºè¿™æ˜¯ä¸€ä¸ªä¼ªäººï¼', false);
                    document.getElementById('fakeBtn').disabled = false;
                } else {
                    addMessage('ç³»ç»Ÿ', 'å®¡è®¯ç»“æŸã€‚ä½ æœªèƒ½è¯†åˆ«å‡ºè¿™æ˜¯ä¸€ä¸ªçœŸå®äººç±»è¿˜æ˜¯ä¼ªäººã€‚', false);
                    document.getElementById('fakeBtn').disabled = false;
                }
            }
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // é¡µé¢åŠ è½½åç›´æ¥å¯ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = `<div class="message system-message">
                <strong>ç³»ç»Ÿ:</strong> æ¸¸æˆå·²å‡†å¤‡å°±ç»ªã€‚è¾“å…¥ç§å­æˆ–ç‚¹å‡»â€œéšæœºç§å­â€å¼€å§‹ä¸€åœºå®¡è®¯ã€‚
            </div>`;
             // å¯ç”¨ç§å­è¾“å…¥å’ŒæŒ‰é’®
            document.getElementById('seedInput').disabled = false;
            document.querySelector('.seed-input button').disabled = false;
            document.querySelectorAll('.seed-input button')[1].disabled = false;
        });

    </script>
</body>
</html> 