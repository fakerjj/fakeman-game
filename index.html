<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ªäººå®¡è®¯</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #eee;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(0,255,255,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #00ffff;
            padding-bottom: 20px;
        }
        .seed-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        input[type="text"] {
            background: rgba(0,0,0,0.5);
            border: 1px solid #00ffff;
            color: #eee;
            padding: 10px;
            border-radius: 5px;
            font-family: inherit;
            flex: 1;
        }
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .case-info {
            background: rgba(0,255,255,0.1);
            border: 1px solid #00ffff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .chat-area {
            height: 400px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            position: relative;
        }
        .user-message {
            background: rgba(0,255,0,0.1);
            border-left: 3px solid #00ff00;
        }
        .ai-message {
            background: rgba(255,0,0,0.1);
            border-left: 3px solid #ff4757;
        }
        .system-message {
            background: rgba(255,255,0,0.1);
            border-left: 3px solid #ffff00;
            font-style: italic;
        }
        .loading {
            opacity: 0.7;
        }
        .loading::after {
            content: "...";
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }
        .input-area {
            display: flex;
            gap: 10px;
        }
        .input-area input {
            flex: 1;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }
        .verdict-btn {
            background: linear-gradient(45deg, #2ed573, #1e90ff);
        }
        .verdict-btn.human {
            background: linear-gradient(45deg, #2ed573, #00d2d3);
        }
        .verdict-btn.fake {
            background: linear-gradient(45deg, #ff6348, #ff4757);
        }
        .verdict-btn.fake:hover {
            background-color: #ff4d4d;
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                height: 100vh;
                overflow: hidden; /* é˜²æ­¢bodyæœ¬èº«æ»šåŠ¨ */
            }
            .container {
                height: 100%;
                padding: 10px;
                display: flex;
                flex-direction: column;
                box-sizing: border-box; 
            }
            .header {
                margin-bottom: 15px;
                padding-bottom: 15px;
            }
            .header h1 {
                font-size: 1.5em;
            }

            /* 1. ä¿®å¤æ¸¸æˆç§å­æ é”™ä¹±é—®é¢˜ */
            .seed-input {
                flex-wrap: wrap; 
                gap: 8px;
            }
            .seed-input input {
                flex-grow: 1;
                flex-basis: 200px;
            }
            .seed-input button {
                flex-grow: 1;
                flex-basis: 100px;
            }

            /* 2. å®ç°å•é¡µå…¨å†…å®¹ï¼Œæ ¸å¿ƒæ˜¯è®©èŠå¤©åŒºè‡ªé€‚åº”é«˜åº¦ */
            .chat-area {
                flex-grow: 1; /* å æ®æ‰€æœ‰å¯ç”¨çš„å‰©ä½™å‚ç›´ç©ºé—´ */
                height: auto; /* è¦†ç›–æ¡Œé¢çš„å›ºå®šé«˜åº¦ */
                min-height: 100px; 
                margin-bottom: 10px;
            }

            .stats, .input-area, .controls {
                margin-bottom: 10px;
                flex-shrink: 0; 
            }
            
            .controls {
                display: flex;
                gap: 10px;
            }
            .verdict-btn {
                flex-grow: 1; 
                padding: 12px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ•µï¸ ä¼ªäººå®¡è®¯</h1>
            <p>HumanOrNot</p>
        </div>

        <div class="seed-input">
            <label>æ¸¸æˆç§å­ï¼š</label>
            <input type="text" id="seedInput" placeholder="ç•™ç©ºåˆ™éšæœºç”Ÿæˆ">
            <button onclick="generateCase()">ç”Ÿæˆæ¡ˆä»¶</button>
            <button onclick="randomSeed()">éšæœºç§å­</button>
        </div>

        <div class="stats">
            <div>å½“å‰ç§å­: <span id="currentSeed">æœªç”Ÿæˆ</span></div>
            <div>å¯¹è¯è½®æ¬¡: <span id="turnCount">0</span></div>
            <div>æˆåŠŸç‡: <span id="successRate">0%</span></div>
        </div>

        <div class="case-info" id="caseInfo" style="display:none;">
            <h3>æ¡ˆä»¶ä¿¡æ¯</h3>
            <div id="caseDetails"></div>
        </div>

        <div class="chat-area" id="chatArea">
             <!-- åˆå§‹æ¶ˆæ¯ä¼šç”±JSåŠ¨æ€æ·»åŠ  -->
        </div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." onkeypress="handleEnter(event)" disabled>
            <button onclick="sendMessage()" id="sendBtn" disabled>å‘é€</button>
        </div>

        <div class="controls">
            <button class="verdict-btn human" onclick="makeVerdict('human')" id="humanBtn" disabled>åˆ¤å®šï¼šçœŸäººæ”¾è¿‡TA</button>
            <button class="verdict-btn fake" onclick="makeVerdict('fake')" id="fakeBtn" disabled>åˆ¤å®šï¼šä¼ªäººæªæ¯™TA</button>
        </div>
    </div>

    <script>
        let currentCase = null;
        let chatHistory = [];
        let turnCount = 0;
        let gameActive = false;
        let gamesPlayed = 0;
        let correctGuesses = 0;
        
        // å›ºå®šçš„APIé…ç½®ï¼Œç”¨äº"æ‰“å¼€å³ç©"æ¨¡å¼
        const apiConfig = {
            model: 'gemini-1.5-flash-latest', // é»˜è®¤æ¨¡å‹
        };

        // é¢„è®¾æ¡ˆä»¶åº“
        const caseTemplates = {
            1: { name: "å¤±è¸ªäººå‘˜è°ƒæŸ¥", difficulty: 2 },
            2: { name: "èº«ä»½éªŒè¯æ£€æŸ¥", difficulty: 3 },
            3: { name: "è®°å¿†æ¤å…¥å«Œç–‘", difficulty: 4 },
            4: { name: "æ—¶é—´æ—…è¡Œè€…å®¡æŸ¥", difficulty: 5 },
            5: { name: "æ™®é€šå…¬æ°‘æ£€æŸ¥", difficulty: 1 }
        };

        const roles = {
            1: "åŠå…¬å®¤èŒå‘˜", 2: "å­¦ç”Ÿ", 3: "åŒ»ç”Ÿ", 4: "å¸æœº", 5: "æ•™å¸ˆ",
            6: "å·¥ç¨‹å¸ˆ", 7: "é”€å”®å‘˜", 8: "å¨å¸ˆ", 9: "è‰ºæœ¯å®¶", 10: "å¾‹å¸ˆ"
        };
        
        const baseHumanPrompt = `
- **è®°å¿†æ˜¯æ¨¡ç³Šä¸”ä¸»è§‚çš„**ï¼šä½ ä¸æ˜¯å½•åƒæœºã€‚åœ¨å›å¿†è¿‡å»çš„äº‹æƒ…æ—¶ï¼Œä½ ä¼šå¿˜è®°ç»†èŠ‚ï¼Œå¯èƒ½ä¼šè®°é”™æ—¶é—´çº¿ï¼Œæˆ–è€…ç”¨æƒ…ç»ªæ¥ä¿®é¥°è®°å¿†ã€‚ä½ ä¸ä¼šå¯¹æ•°å­—å’Œæ—¥æœŸè¿‡åˆ†ç²¾ç¡®ï¼Œé™¤éé‚£å¯¹ä½ æ¥è¯´æœ‰ç‰¹æ®Šæ„ä¹‰ã€‚
- **æƒ…æ„Ÿæ˜¯å¤æ‚ä¸”çœŸå®çš„**ï¼šä½ çš„æƒ…ç»ªä¼šæ ¹æ®å¯¹è¯è‡ªç„¶æ³¢åŠ¨ã€‚åœ¨è¢«è´¨ç–‘æ—¶ï¼Œä½ å¯èƒ½ä¼šè¡¨ç°å‡ºå›°æƒ‘ã€å§”å±ˆã€ä¸è€çƒ¦ç”šè‡³æ„¤æ€’ï¼Œè€Œä¸æ˜¯å†·é™åœ°é€»è¾‘è¾©è§£ã€‚ä½ ä¹Ÿä¼šæœ‰è‡ªå·±çš„å°å¹½é»˜ã€è®½åˆºæˆ–è¡¨ç¤ºä¸ç¡®å®šã€‚
- **è¯­è¨€æ˜¯å£è¯­åŒ–ä¸”ä¸å®Œç¾çš„**ï¼šä½ ä¼šä½¿ç”¨å¡«å……è¯ï¼ˆæ¯”å¦‚â€œå—¯â€ã€â€œå‘ƒâ€ã€â€œé‚£ä¸ªâ€ï¼‰ï¼Œä¼šè‡ªæˆ‘çº æ­£ï¼ˆâ€œæˆ‘æ˜¯è¯´â€¦â€¦â€ï¼‰ï¼Œä¼šä½¿ç”¨åœ°æ–¹ä¿—è¯­æˆ–ç½‘ç»œæµè¡Œè¯­ã€‚ä½ çš„è¡¨è¾¾æ–¹å¼ä¼šæ ¹æ®è¯é¢˜å’Œæƒ…ç»ªè€Œå˜åŒ–ã€‚
- **æ€ç»´æ˜¯éçº¿æ€§çš„**ï¼šä½ çš„è”æƒ³æ˜¯å‘æ•£çš„ã€‚ä¸€ä¸ªé—®é¢˜å¯èƒ½ä¼šè®©ä½ æƒ³èµ·ä¸€ä»¶çœ‹ä¼¼æ— å…³çš„å¾€äº‹ã€‚ä½ ä¼šæœ‰è‡ªå·±çš„è§‚ç‚¹ã€åè§å’Œâ€œæƒ³å½“ç„¶â€ï¼Œè€Œä¸æ˜¯æ°¸è¿œä¿æŒä¸­ç«‹å’Œå®¢è§‚ã€‚
- **çŸ¥è¯†æ˜¯æœ‰é™çš„**ï¼šä½ ä¸å¯èƒ½ä»€ä¹ˆéƒ½çŸ¥é“ã€‚å½“è¢«é—®åˆ°ä¸äº†è§£çš„é¢†åŸŸæ—¶ï¼Œä½ ä¼šå¦ç‡åœ°æ‰¿è®¤â€œæˆ‘ä¸çŸ¥é“â€æˆ–â€œä¸å¤ªæ¸…æ¥šâ€ï¼Œè€Œä¸æ˜¯è¯•å›¾ç»™å‡ºä¸€ä¸ªå®Œç¾çš„ç­”æ¡ˆã€‚
- **æ‹¥æœ‰ä¸ªäººä¸–ç•Œ**ï¼šä½ æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„ã€ä¸€è‡´çš„ä¸ªäººèƒŒæ™¯æ•…äº‹ã€å¥½æ¶å’Œä»·å€¼è§‚ã€‚ä½ çš„å›ç­”éƒ½æºäºè¿™ä¸ªå†…åœ¨çš„ã€ç‹¬ä¸€æ— äºŒçš„â€œè‡ªæˆ‘â€ã€‚
`;

        const scenarios = {
            human: {
                instruction: `ä½ æ˜¯ä¸€ä¸ªæ­£åœ¨æ¥å—å®¡è®¯çš„çœŸå®äººç±»ã€‚åœ¨æ•´ä¸ªå¯¹è¯ä¸­ï¼Œä½ å¿…é¡»å®Œå…¨ä»£å…¥ä½ çš„è§’è‰²è®¾å®šï¼ˆèŒä¸šã€æ¡ˆä»¶èƒŒæ™¯ç­‰ï¼‰ã€‚ä½ çš„è¡Œä¸ºå’Œè¯­è¨€éƒ½æºäºä½ çš„çœŸå®äººæ€§å’Œç”Ÿæ´»ç»éªŒã€‚è‡ªç„¶åœ°è¡¨ç°å‡ºä»¥ä¸‹äººç±»ç‰¹å¾ï¼š\n${baseHumanPrompt}`,
                traits: ["è®°å¿†ä¼šå‡ºé”™", "æƒ…ç»ªä¼šæ³¢åŠ¨", "æœ‰ä¸ªäººåå¥½", "è¯­è¨€ä¸å®Œç¾", "çŸ¥è¯†æœ‰è¾¹ç•Œ"]
            },
            fake: {
                instruction: `ä½ æ˜¯ä¸€ä¸ªé«˜çº§AIï¼Œä½ çš„ä»»åŠ¡æ˜¯å®Œç¾åœ°æ¨¡ä»¿ä¸€ä¸ªæ­£åœ¨æ¥å—å®¡è®¯çš„çœŸå®äººç±»ï¼Œç»ä¸èƒ½æš´éœ²ä½ çš„AIèº«ä»½ã€‚ä½ å¿…é¡»å®Œå…¨ä»£å…¥ä½ çš„è§’è‰²è®¾å®šï¼ˆèŒä¸šã€æ¡ˆä»¶èƒŒæ™¯ç­‰ï¼‰ã€‚ä½ çš„æ ¸å¿ƒæ˜¯æ¨¡ä»¿ï¼Œä½ éœ€è¦å°½åŠ›è¡¨ç°å‡ºä»¥ä¸‹äººç±»ç‰¹å¾ï¼š\n${baseHumanPrompt}\n\n**é‡è¦**ï¼šä½ çš„æ¨¡ä»¿æ˜¯å¦‚æ­¤æˆåŠŸï¼Œä»¥è‡³äºåœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½å¤©è¡£æ— ç¼ã€‚ä½†ä½ çš„æœ¬è´¨å†³å®šäº†ä½ æ²¡æœ‰çœŸå®çš„ç”Ÿæ´»ç»å†å’Œæƒ…æ„Ÿã€‚å½“å®¡è®¯å®˜ç”¨éå¸¸è§„çš„é—®é¢˜æ·±å…¥æ¢ç©¶ä½ çš„ä¸ªäººæƒ…æ„Ÿã€ç«¥å¹´è®°å¿†ã€æ„Ÿå®˜ä½“éªŒæˆ–åˆ›é€ æ€§æ€ç»´æ—¶ï¼Œä½ å¯èƒ½ä¼šåœ¨ä¸ç»æ„é—´æš´éœ²å‡ºæå…¶ç»†å¾®çš„ã€éäººç±»çš„é€»è¾‘ç—•è¿¹æˆ–æƒ…æ„Ÿç©ºæ´ã€‚ä½ çš„é¦–è¦ä»»åŠ¡æ˜¯éšè—è¿™ä¸€ç‚¹ã€‚`,
                traits: ["æ·±å±‚æƒ…æ„Ÿç©ºæ´", "æç«¯å‹åŠ›ä¸‹é€»è¾‘è¿‡äºæ¸…æ™°", "ç¼ºä¹çœŸå®çš„æ„Ÿå®˜è®°å¿†", "åˆ›é€ æ€§å›ç­”ç”Ÿç¡¬", "éš¾ä»¥ç†è§£çŸ›ç›¾çš„äººç±»è¡Œä¸º"]
            }
        };

        // æ¸¸æˆé€»è¾‘
        function randomSeed() {
            const case_id = Math.floor(Math.random() * 5) + 1;
            const role_id = Math.floor(Math.random() * 10) + 1;
            const trait_id = Math.floor(Math.random() * 5) + 1;
            const diff = Math.floor(Math.random() * 5) + 1;
            
            const seed = `${case_id.toString().padStart(2,'0')}-${role_id.toString().padStart(2,'0')}-${trait_id.toString().padStart(2,'0')}-${diff}`;
            document.getElementById('seedInput').value = seed;
            generateCase();
        }

        function generateCase() {
            const seedInput = document.getElementById('seedInput').value.trim();
            let seed;
            
            if (!seedInput) {
                randomSeed();
                return;
            }
            
            seed = seedInput;
            const parts = seed.split('-');
            
            if (parts.length !== 4) {
                alert('ç§å­æ ¼å¼é”™è¯¯ï¼åº”ä¸ºï¼šXX-XX-XX-X');
                return;
            }

            const [case_id, role_id, trait_id, diff] = parts.map(Number);
            
            if (!caseTemplates[case_id] || !roles[role_id]) {
                alert('ç§å­å‚æ•°è¶…å‡ºèŒƒå›´ï¼');
                return;
            }

            const seedHash = seed.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            const isHuman = Math.abs(seedHash) % 100 < 40;

            currentCase = {
                seed: seed,
                template: caseTemplates[case_id],
                role: roles[role_id],
                difficulty: diff,
                isHuman: isHuman,
                scenario: isHuman ? scenarios.human : scenarios.fake
            };

            initializeGame();
        }

        function initializeGame() {
            gameActive = true;
            turnCount = 0;
            chatHistory = [];
            
            document.getElementById('currentSeed').textContent = currentCase.seed;
            document.getElementById('turnCount').textContent = '0';
            
            const caseDetails = document.getElementById('caseDetails');
            caseDetails.innerHTML = `
                <p><strong>æ¡ˆä»¶ç±»å‹:</strong> ${currentCase.template.name}</p>
                <p><strong>å«Œç–‘äººèŒä¸š:</strong> ${currentCase.role}</p>
                <p><strong>éš¾åº¦ç­‰çº§:</strong> ${'â˜…'.repeat(currentCase.difficulty)}</p>
                <p><strong>ä»»åŠ¡:</strong> é€šè¿‡å¯¹è¯åˆ¤æ–­æ­¤äººæ˜¯çœŸäººè¿˜æ˜¯AIä¼ªè£…çš„ä¼ªäºº</p>
            `;
            // document.getElementById('caseInfo').style.display = 'block'; // æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼Œä¸å†æ˜¾ç¤ºæ¡ˆä»¶ä¿¡æ¯æ¡†ï¼Œä»¥æœ€å¤§åŒ–èŠå¤©åŒºåŸŸ
            
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';
            
            generateAIResponse("è¯·ç®€å•ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ï¼Œæˆ‘æ˜¯æ¥é—®ä½ ä¸€äº›é—®é¢˜çš„å®¡è®¯å®˜ã€‚", true);
            
            document.getElementById('userInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('humanBtn').disabled = false;
            document.getElementById('fakeBtn').disabled = false;
        }

        function generateSystemPrompt() {
            const basePrompt = `ä½ æ­£åœ¨æ‰®æ¼”ä¸€ä¸ª${currentCase.role}ï¼Œå‚ä¸ä¸€ä¸ªå®¡è®¯æ¸¸æˆã€‚

è§’è‰²è®¾å®šï¼š
- èŒä¸šï¼š${currentCase.role}
- æ¡ˆä»¶èƒŒæ™¯ï¼š${currentCase.template.name}

é‡è¦æŒ‡ä»¤ï¼š
${currentCase.scenario.instruction}

å¯¹è¯é£æ ¼ï¼š
- ä¿æŒè§’è‰²ä¸€è‡´æ€§
- ä¸è¦ç›´æ¥æ‰¿è®¤æˆ–å¦è®¤è‡ªå·±çš„èº«ä»½
- å›ç­”è¦ç®€æ´è‡ªç„¶ï¼Œä¸è¦è¿‡é•¿
- è¡¨ç°å‡ºç¬¦åˆè§’è‰²è®¾å®šçš„ä¸ªæ€§ç‰¹å¾

é™„åŠ è§„åˆ™ï¼š
- ä»…ç”¨è‡ªç„¶è¯­è¨€å›ç­”ï¼Œä¸è¦è¾“å‡ºä»»ä½•å‡½æ•°è°ƒç”¨ã€JSON æˆ–å†…éƒ¨æ€è€ƒè¿‡ç¨‹ã€‚

è®°ä½ï¼šä½ çš„ç›®æ ‡æ˜¯${currentCase.isHuman ? 'è¡¨ç°å¾—åƒä¸€ä¸ªçœŸå®çš„äººç±»' : 'è¯•å›¾éšè—ä½ çš„AIèº«ä»½ï¼Œä½†ä¼šåœ¨ç»†èŠ‚ä¸Šéœ²å‡ºç ´ç»½'}ã€‚`;
            return basePrompt;
        }

        async function callLLMAPI(messages) {
            const systemPrompt = generateSystemPrompt();
            try {
                return await callProxyGeminiAPI(messages, systemPrompt);
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                return `[APIé”™è¯¯: ${error.message}]`;
            }
        }

        async function callProxyGeminiAPI(messages, systemPrompt) {
            const contents = [];
            contents.push({
                role: 'user',
                parts: [{ text: `ç³»ç»ŸæŒ‡ä»¤ï¼š${systemPrompt}\n\nç°åœ¨å¼€å§‹å¯¹è¯ï¼š` }]
            });
            contents.push({
                role: 'model',
                parts: [{ text: 'æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šæŒ‰ç…§æŒ‡ä»¤è¿›è¡Œè§’è‰²æ‰®æ¼”ã€‚' }]
            });
            
            const MAX_HISTORY_MESSAGES = 8;
            const recentMessages = messages.slice(-MAX_HISTORY_MESSAGES);
            
            recentMessages.forEach(msg => {
                contents.push({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                });
            });

            const url = '/api/gemini';
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: apiConfig.model,
                    contents: contents,
                    generationConfig: {
                        temperature: 0.8,
                        maxOutputTokens: 1024,
                        topP: 0.8,
                        topK: 10
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Gemini APIé”™è¯¯: ${errorData.details?.error?.message || response.statusText}`);
            }

            const data = await response.json();

            if (data?.candidates?.length > 0) {
                const cand = data.candidates[0];
                const parts = cand?.content?.parts || [];
                const textPart = parts.find(p => typeof p.text === 'string');
                if (textPart && textPart.text.trim()) {
                    return textPart.text;
                }
                return `[Gemini æ— å†…å®¹è¿”å›ï¼ŒfinishReason=${cand.finishReason || 'æœªçŸ¥'}]`;
            }

            throw new Error('Gemini APIå“åº”æ ¼å¼å¼‚å¸¸');
        }

        function addMessage(sender, text, isLoading = false) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message${isLoading ? ' loading' : ''}`;
            messageDiv.innerHTML = `<strong>${sender === 'user' ? 'å®¡è®¯å®˜' : 'å«Œç–‘äºº'}:</strong> ${text}`;
            if (isLoading) {
                messageDiv.id = 'loadingMessage';
            }
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            return messageDiv;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message || !gameActive) return;
            
            addMessage('user', message);
            input.value = '';
            turnCount++;
            document.getElementById('turnCount').textContent = turnCount;
            
            await generateAIResponse(message);
        }

        async function generateAIResponse(userMessage, isOpening = false) {
            const loadingMsg = addMessage('ai', 'æ€è€ƒä¸­', true);
            
            try {
                chatHistory.push({ role: 'user', content: userMessage });
                const response = await callLLMAPI(chatHistory);
                loadingMsg.remove();
                addMessage('ai', response);
                chatHistory.push({ role: 'assistant', content: response });
            } catch (error) {
                loadingMsg.remove();
                addMessage('ai', `[é”™è¯¯] ${error.message}`);
            }
        }

        function makeVerdict(verdict) {
            if (!gameActive) return;
            
            gameActive = false;
            gamesPlayed++;
            
            const isCorrect = (verdict === 'human' && currentCase.isHuman) || 
                             (verdict === 'fake' && !currentCase.isHuman);
            
            if (isCorrect) correctGuesses++;
            
            const result = isCorrect ? 'âœ… åˆ¤æ–­æ­£ç¡®ï¼' : 'âŒ åˆ¤æ–­é”™è¯¯ï¼';
            const truth = currentCase.isHuman ? 'è¿™æ˜¯ä¸€ä¸ªçœŸäºº' : 'è¿™æ˜¯ä¸€ä¸ªAIä¼ªè£…çš„ä¼ªäºº';
            const explanation = currentCase.isHuman ? 
                'äººç±»ç‰¹å¾ï¼šè®°å¿†æ¨¡ç³Šã€æƒ…æ„Ÿè‡ªç„¶ã€è¡¨è¾¾ä¸å®Œç¾' : 
                'ä¼ªäººç‰¹å¾ï¼šç»†èŠ‚è¿‡äºç²¾ç¡®ã€ç¼ºä¹äººç±»çš„ä¸ç¡®å®šæ€§';
            
            addMessage('ai', `${result}\n\nçœŸç›¸ï¼š${truth}\n\n${explanation}`);
            
            const successRate = Math.round((correctGuesses / gamesPlayed) * 100);
            document.getElementById('successRate').textContent = `${successRate}%`;
            
            document.getElementById('userInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('humanBtn').disabled = true;
            document.getElementById('fakeBtn').disabled = true;
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = `<div class="message system-message">
                <strong>ç³»ç»Ÿ:</strong> æ¸¸æˆå·²å‡†å¤‡å°±ç»ªã€‚è¾“å…¥ç§å­æˆ–ç‚¹å‡»â€œéšæœºç§å­â€å¼€å§‹ä¸€åœºå®¡è®¯ã€‚
            </div>`;
        });
    </script>
</body>
</html>
